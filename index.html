<!doctype html>
<html>

  <head>
  	<meta charset="UTF-8">
    <title>P3 IRAC - G30</title>
  </head>
  <body>
  	<h1>Video DASH</h1>
  	<div>
     <div class="code">
     	<video class="dashjs-player" autoplay controls preload="auto" muted></video>
     	Representation: <span id="representation"></span>
     </div>
     <div style="display: flex; flex-direction: row">

     	<canvas id="bufferLevelChart" width="400" height="400"></canvas>
     	<canvas id="bitrateChart" width="400" height="400"></canvas>
     </div>
    </div>
	<div>
		<p>
			<strong>Miembros</strong>
			Álvaro de Pablo Marsal <br>
			Alonso de la Hera Herrera<br>
			Alberto López Santiago<br>
			Álvaro López García<br>
		</p>
		
	</div>

	 <button onclick="alert('Que te lo has creído')">Aprobar</button>

  </body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/3.0.0/dash.all.min.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script> 
<script>
	bufferChartRef = document.getElementById('bufferLevelChart');
	var bufferChart = new Chart(bufferChartRef, {
    type: 'line',
    data: {
		labels: [],
		datasets: [{ 
        data: [],
        label: "Buffer Level",
        borderColor: "#3e95cd",
        fill: false
      }]
  },
    options: {
    	responsive: false,
    	title: {
	      display: true,
	      text: 'Buffer Level (secs)'
	    },
        scales: {
            yAxes: [{
                stacked: true
            }]
        }
    }
});

BitrateRef = document.getElementById('bitrateChart');
var BitrateChart = new Chart(BitrateRef, {
    type: 'line',
    data: {
		labels: [],
		datasets: [{ 
        data: [],
        label: "Bitrate",
        borderColor: "#3e95cd",
        fill: false
      }]
  },
    options: {
    	responsive:false,
    	title: {
	      display: true,
	      text: 'Bitrate (kbps)'
	    },
        scales: {
            yAxes: [{
                stacked: true
            }]
        }
    }
});
	function addData(chart, label, data) {
    chart.data.labels.push(label);
    chart.data.datasets.forEach((dataset) => {
        dataset.data.push(data);
    });
    chart.update();
}

function removeData(chart) {
    chart.data.labels.pop();
    chart.data.datasets.forEach((dataset) => {
        dataset.data.pop();
    });
    chart.update();
}
</script>

<script>
var index = 0
document.addEventListener("DOMContentLoaded", function(){
	init();
});
function init(){
	
	var video,
	 player,
	 mpd_url ="./output/manifest.mpd";

	video = document.querySelector("video");
	player = dashjs.MediaPlayer().create();
	player.initialize(video, mpd_url, true);
	player.on(dashjs.MediaPlayer.events["PLAYBACK_ENDED"], function() {
		clearInterval(eventPoller);
	});

	var eventPoller = setInterval(function() {
		var streamInfo = player.getActiveStream().getStreamInfo();
		var dashMetrics = player.getDashMetrics();
		var dashAdapter = player.getDashAdapter();

		if (dashMetrics && streamInfo) {
			
			const periodIdx = streamInfo.index;
			var repSwitch = dashMetrics.getCurrentRepresentationSwitch('video', true);
			var bufferLevel = dashMetrics.getCurrentBufferLevel('video', true);
			var bitrate = repSwitch ? Math.round(dashAdapter.getBandwidthForRepresentation(repSwitch.to, periodIdx) / 1000): NaN;
			addData(bufferChart,index*500,bufferLevel)
			addData(BitrateChart,index*500,bitrate)
			index = index+1;
			document.getElementById('representation').innerText = repSwitch.to;
		}
	}, 500);
}
</script>


</html>
